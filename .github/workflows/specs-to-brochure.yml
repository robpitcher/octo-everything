# Specs to Brochure Automation
# Automatically generates HTML brochures from markdown specs and updates README table of contents
#
# Architecture:
#   specs/demoplan/*.md ‚Üí GitHub Actions ‚Üí pm-demo.html + README.md update
#
# This workflow demonstrates "dogfooding" GitHub for the full SDLC:
# - Using GitHub Actions for automation (replaces Jenkins/external CI)
# - Using GitHub repository as single source of truth
# - Auto-linking content across the repository

name: Generate Brochure from Specs

on:
  push:
    branches:
      - main
    paths:
      - 'specs/demoplan/*.md'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all brochures'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  SPECS_DIR: specs/demoplan
  OUTPUT_DIR: specs/demoplan

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.changes.outputs.all_changed_files }}
      any_changed: ${{ steps.changes.outputs.any_changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed markdown files
        id: changes
        uses: tj-actions/changed-files@v44
        with:
          files: |
            specs/demoplan/*.md
            !specs/demoplan/*.html

  generate-brochure:
    needs: detect-changes
    if: needs.detect-changes.outputs.any_changed == 'true' || github.event.inputs.force_regenerate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # This step would use a custom script or Copilot API to generate HTML
      # For now, we document the expected behavior
      - name: Generate HTML Brochure
        id: generate
        run: |
          echo "üìÑ Processing markdown specs..."
          echo "Changed files: ${{ needs.detect-changes.outputs.changed_files }}"
          
          # For each changed markdown file, extract key sections and generate HTML
          # In production, this would call a script that:
          # 1. Parses the markdown for personas, SDLC phases, tool mappings
          # 2. Generates sleek HTML with inline styles (email-safe)
          # 3. Updates the corresponding .html file
          
          # Example: pm-demo-guide.md ‚Üí pm-demo.html
          for file in ${{ needs.detect-changes.outputs.changed_files }}; do
            if [[ "$file" == *.md ]]; then
              html_file="${file%.md}.html"
              echo "Would generate: $file ‚Üí $html_file"
            fi
          done
          
          echo "generated=true" >> $GITHUB_OUTPUT

      - name: Update README Table of Contents
        if: steps.generate.outputs.generated == 'true'
        run: |
          echo "üìã Updating README.md with table of contents..."
          
          # Generate table of contents for all HTML brochures in specs/demoplan
          TOC_SECTION="## üìë Demo Brochures\n\n"
          TOC_SECTION+="| Document | Description | Last Updated |\n"
          TOC_SECTION+="|----------|-------------|---------------|\n"
          
          for html in specs/demoplan/*.html; do
            if [[ -f "$html" ]]; then
              filename=$(basename "$html")
              # Extract title from HTML if possible
              title=$(grep -oP '(?<=<title>).*(?=</title>)' "$html" 2>/dev/null || echo "$filename")
              date=$(date -r "$html" "+%Y-%m-%d" 2>/dev/null || echo "N/A")
              TOC_SECTION+="| [$filename]($html) | $title | $date |\n"
            fi
          done
          
          echo -e "$TOC_SECTION"
          # In production, this would update the README.md file

      - name: Commit changes
        if: steps.generate.outputs.generated == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check for changes
          if [[ -n $(git status --porcelain) ]]; then
            git add specs/demoplan/*.html README.md
            git commit -m "üîÑ Auto-generate brochures from specs [skip ci]"
            git push
            echo "‚úÖ Changes committed and pushed"
          else
            echo "‚ÑπÔ∏è No changes to commit"
          fi

  # Optional: Create PR instead of direct push for review
  create-pr:
    needs: [detect-changes, generate-brochure]
    if: github.event.inputs.force_regenerate == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "üîÑ Regenerate all brochures from specs"
          title: "[Auto] Brochure regeneration"
          body: |
            ## üîÑ Auto-generated Brochure Update
            
            This PR was automatically generated by the specs-to-brochure workflow.
            
            ### Changes
            - Regenerated HTML brochures from markdown specs
            - Updated README.md table of contents
            
            ### Review Checklist
            - [ ] HTML styling is correct and email-safe
            - [ ] All personas are represented
            - [ ] No pricing information included
            - [ ] No demo repository references
          branch: auto/brochure-update
          delete-branch: true
          labels: |
            automated
            documentation
